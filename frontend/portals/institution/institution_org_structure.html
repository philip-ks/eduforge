<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Org Structure | EduForge</title>
  <link rel="stylesheet" href="../../css/style.css" />
  <style>
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 12px 0 18px; }
    .tabs { display:flex; gap:10px; flex-wrap:wrap; margin: 8px 0 12px; }
    .tab { padding:8px 12px; border:1px solid rgba(255,255,255,0.14); border-radius:10px; cursor:pointer; opacity:0.85; }
    .tab.active { opacity:1; border-color: rgba(255,255,255,0.28); }
    .card { margin-top: 10px; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align:left; padding:10px 8px; border-bottom: 1px solid rgba(255,255,255,0.08); vertical-align: top; }
    th { opacity: 0.8; font-weight: 600; }
    .actions { display:flex; gap:8px; }
    .btn { padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.14); background: transparent; color: inherit; cursor:pointer; }
    .btn.primary { border-color: rgba(255,255,255,0.28); }
    .btn.danger { border-color: rgba(255,100,100,0.35); }
    .muted { opacity: 0.75; }

    /* Modal */
    .modalOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; padding: 16px; }
    .modal { width: min(520px, 100%); background: rgba(20,20,20,0.98); border:1px solid rgba(255,255,255,0.12); border-radius: 14px; padding: 14px; }
    .modalHeader { display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px; }
    .modalTitle { font-weight: 700; }
    .formRow { margin: 10px 0; }
    .formRow label { display:block; margin-bottom: 6px; opacity: 0.85; }
    .formRow input, .formRow select { width: 100%; padding:10px 10px; border-radius: 10px; border:1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.04); color: inherit; }
    .modalFooter { display:flex; justify-content:flex-end; gap:10px; margin-top: 12px; }
    .pill { display:inline-block; padding:4px 10px; border:1px solid rgba(255,255,255,0.14); border-radius: 999px; opacity:0.85; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="brand-text">
        <div class="brand-name">EduForge</div>
        <div class="brand-tagline">Org Structure</div>
      </div>
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn" id="backBtn">Back</button>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </header>

  <main class="container">
    <h1>Org Structure</h1>
    <div class="muted">Manage Departments, Designations, and Subjects.</div>

    <div class="tabs">
      <div class="tab active" data-tab="departments">Departments</div>
      <div class="tab" data-tab="designations">Designations</div>
      <div class="tab" data-tab="subjects">Subjects</div>
    </div>

    <div class="toolbar">
      <button class="btn primary" id="addBtn">+ Add</button>
      <button class="btn" id="refreshBtn">Refresh</button>
      <span class="pill" id="statusPill">Ready</span>
    </div>

    <div class="card">
      <div id="tableWrap"></div>
    </div>
  </main>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle" id="modalTitle">Add</div>
        <button class="btn" id="closeModalBtn">X</button>
      </div>

      <div class="formRow" id="deptSelectRow" style="display:none;">
        <label for="departmentSelect">Department</label>
        <select id="departmentSelect"></select>
      </div>

      <div class="formRow">
        <label for="nameInput" id="nameLabel">Name</label>
        <input id="nameInput" type="text" placeholder="Enter name" />
      </div>

      <div class="modalFooter">
        <button class="btn" id="cancelBtn">Cancel</button>
        <button class="btn primary" id="saveBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- ORDER MATTERS -->
  <script src="../../assets/eduforge_config.js"></script>
  <script src="../../assets/eduforge_auth.js"></script>
  <script src="../../assets/institution.js"></script>

  <script>
    // ---- helpers ----
    const $ = (id) => document.getElementById(id);

    const state = {
      tab: "departments",
      departments: [],
      designations: [],
      subjects: [],
      editing: null, // { mode: "add"|"edit", id?: string }
    };

    function setStatus(text) { $("statusPill").textContent = text; }

    function apiBaseFor(tab) {
      if (tab === "departments") return "/org/departments";
      if (tab === "designations") return "/org/designations";
      if (tab === "subjects") return "/org/subjects";
      throw new Error("Unknown tab: " + tab);
    }

    function labelFor(tab) {
      if (tab === "departments") return "Department Name";
      if (tab === "designations") return "Designation Title";
      if (tab === "subjects") return "Subject Name";
      return "Name";
    }

    function needsDepartment(tab) {
      return tab === "designations" || tab === "subjects";
    }

    function getListFor(tab) {
      if (tab === "departments") return state.departments;
      if (tab === "designations") return state.designations;
      if (tab === "subjects") return state.subjects;
      return [];
    }

    function setListFor(tab, rows) {
      if (tab === "departments") state.departments = rows;
      if (tab === "designations") state.designations = rows;
      if (tab === "subjects") state.subjects = rows;
    }

    function deptNameById(id) {
      const d = state.departments.find(x => x.id === id);
      return d ? d.name : "â€”";
    }

    // ---- rendering ----
    function renderTable() {
      const tab = state.tab;
      const rows = getListFor(tab);

      const showDeptCol = needsDepartment(tab);
      const nameCol = (tab === "designations") ? "title" : "name";

      let html = `
        <table>
          <thead>
            <tr>
              ${showDeptCol ? "<th>Department</th>" : ""}
              <th>${tab === "designations" ? "Title" : "Name"}</th>
              <th>Status</th>
              <th style="width:140px;">Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      if (!rows.length) {
        html += `<tr><td colspan="${showDeptCol ? 4 : 3}" class="muted">No records yet.</td></tr>`;
      } else {
        for (const r of rows) {
          html += `
            <tr>
              ${showDeptCol ? `<td>${deptNameById(r.departmentId)}</td>` : ""}
              <td>${escapeHtml(String(r[nameCol] ?? ""))}</td>
              <td>${r.isActive ? "Active" : "Inactive"}</td>
              <td>
                <div class="actions">
                  <button class="btn" data-action="edit" data-id="${r.id}">Edit</button>
                  <button class="btn danger" data-action="delete" data-id="${r.id}">Delete</button>
                </div>
              </td>
            </tr>
          `;
        }
      }

      html += `</tbody></table>`;
      $("tableWrap").innerHTML = html;

      // bind actions
      $("tableWrap").querySelectorAll("button[data-action]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const action = btn.getAttribute("data-action");
          const id = btn.getAttribute("data-id");
          if (action === "edit") openEdit(id);
          if (action === "delete") await doDelete(id);
        });
      });
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[c]));
    }

    // ---- data loading ----
    async function loadDepartments() {
      const res = await window.EDUFORGE.apiGet("/org/departments");
      if (!res?.ok) throw new Error(res?.error || "Failed to load departments");
      state.departments = res.data || res; // depending on wrapper shape
      if (res.data) state.departments = res.data;
    }

    async function loadCurrentTab() {
      setStatus("Loading...");
      try {
        // Always load departments first because designations/subjects need names
        await loadDepartments();

        const tab = state.tab;
        const res = await window.EDUFORGE.apiGet(apiBaseFor(tab));
        if (!res?.ok && !Array.isArray(res)) throw new Error(res?.error || "Failed to load");
        const rows = res.data ?? res;
        setListFor(tab, rows);

        setStatus("Loaded");
        renderTable();
      } catch (e) {
        console.error(e);
        setStatus("Error");
        $("tableWrap").innerHTML = `<div class="muted">Failed to load. Check console.</div>`;
      }
    }

    // ---- modal logic ----
    function openAdd() {
      state.editing = { mode: "add" };
      $("modalTitle").textContent = "Add " + state.tab.slice(0, -1);
      $("nameLabel").textContent = labelFor(state.tab);
      $("nameInput").value = "";

      if (needsDepartment(state.tab)) {
        $("deptSelectRow").style.display = "block";
        fillDepartmentSelect(null);
      } else {
        $("deptSelectRow").style.display = "none";
      }

      $("modalOverlay").style.display = "flex";
    }

    function openEdit(id) {
      const tab = state.tab;
      const rows = getListFor(tab);
      const row = rows.find(r => r.id === id);
      if (!row) return;

      state.editing = { mode: "edit", id };
      $("modalTitle").textContent = "Edit " + tab.slice(0, -1);
      $("nameLabel").textContent = labelFor(tab);

      const nameCol = (tab === "designations") ? "title" : "name";
      $("nameInput").value = row[nameCol] ?? "";

      if (needsDepartment(tab)) {
        $("deptSelectRow").style.display = "block";
        fillDepartmentSelect(row.departmentId || null);
      } else {
        $("deptSelectRow").style.display = "none";
      }

      $("modalOverlay").style.display = "flex";
    }

    function closeModal() {
      $("modalOverlay").style.display = "none";
      state.editing = null;
    }

    function fillDepartmentSelect(selectedId) {
      const sel = $("departmentSelect");
      sel.innerHTML = "";
      for (const d of state.departments) {
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.name;
        if (selectedId && d.id === selectedId) opt.selected = true;
        sel.appendChild(opt);
      }
      if (!selectedId && sel.options.length) sel.selectedIndex = 0;
    }

    async function doSave() {
      const tab = state.tab;
      const base = apiBaseFor(tab);

      const raw = $("nameInput").value.trim();
      if (!raw) { alert("Please enter a value."); return; }

      const depId = needsDepartment(tab) ? $("departmentSelect").value : null;

      setStatus("Saving...");
      try {
        const isEdit = state.editing?.mode === "edit";
        const id = state.editing?.id;

        // Build payload based on tab; include departmentId when required
        const payload = {};
        if (tab === "designations") {
          payload.title = raw;
          payload.name = raw; // fallback for backward compatibility
          payload.departmentId = depId;
        } else if (tab === "subjects") {
          payload.name = raw;
          payload.departmentId = depId;
        } else {
          // departments
          payload.name = raw;
        }

        // Ensure department is selected for tabs that require it
        if (needsDepartment(tab) && !depId) {
          alert("Department is required.");
          return;
        }

        // Call API
        if (!isEdit) {
          const res = await window.EDUFORGE.apiPost(base, payload);
          if (!res?.ok) throw new Error(res?.error || "Create failed");
        } else {
          const res = await window.EDUFORGE.apiPut(base + "/" + id, payload);
          if (!res?.ok) throw new Error(res?.error || "Update failed");
        }

        closeModal();
        await loadCurrentTab();
        setStatus("Saved");
      } catch (e) {
        console.error(e);
        setStatus("Error");
        alert("Save failed. Check console.");
      }
    }

    async function doDelete(id) {
      if (!confirm("Delete this item?")) return;

      setStatus("Deleting...");
      try {
        const base = apiBaseFor(state.tab);
        const res = await window.EDUFORGE.apiDelete(base + "/" + id);
        if (!res?.ok) throw new Error(res?.error || "Delete failed");
        await loadCurrentTab();
        setStatus("Deleted");
      } catch (e) {
        console.error(e);
        setStatus("Error");
        alert("Delete failed. Check console.");
      }
    }

    // ---- events ----
    document.querySelectorAll(".tab").forEach(t => {
      t.addEventListener("click", async () => {
        document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
        t.classList.add("active");
        state.tab = t.getAttribute("data-tab");
        await loadCurrentTab();
      });
    });

    $("addBtn").onclick = openAdd;
    $("refreshBtn").onclick = loadCurrentTab;
    $("closeModalBtn").onclick = closeModal;
    $("cancelBtn").onclick = closeModal;
    $("saveBtn").onclick = doSave;

    $("backBtn").onclick = () => window.location.href = "./dashboard_institution.html";
    $("logoutBtn").onclick = () => {
      localStorage.removeItem("token");
      window.location.href = "../../auth/login.html";
    };

    // init
    loadCurrentTab();
  </script>
</body>
</html>